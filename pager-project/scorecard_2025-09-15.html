<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Regional Scorecard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
/* ---------------- Sidebar ---------------- */
#sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 250px;
  height: 100vh;
  background-color: #0a2239;
  color: white;
  padding: 20px;
  overflow-y: auto;
  z-index: 1000;
}

#sidebar h4 {
  font-size: 1.2rem;
  font-weight: bold;
  color: #ffffff;
}

#sidebar small {
  color: #b0c4de;
  font-size: 0.95rem;
  font-weight: 600;
}

/* ---------------- Main Content ---------------- */
#main-content {
  margin-left: 270px;
  padding: 20px;
  background: #f8f9fa;
  min-height: 100vh;
}

/* ---------------- Table Styling ---------------- */
#scorecard-table table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 2rem;
}

#scorecard-table th,
#scorecard-table td {
  text-align: center;
  vertical-align: middle;
  border: 1px solid #dee2e6;
}

#scorecard-table th {
  background-color: #e9ecef;
  font-weight: bold;
}

.section-header td {
  background-color: #0a2239;
  color: white;
  font-weight: bold;
  text-align: left;
  padding: 8px 10px;
  font-size: 1rem;
}

/* ---------------- Conditional Formatting ---------------- */
td.pass {
  background: #d4edda;
  color: #155724;
  font-weight: 500;
}

td.warning {
  background: #fff3cd;
  color: #856404;
  font-weight: 500;
}

td.fail {
  background: #f8d7da;
  color: #721c24;
  font-weight: 500;
}

td.na {
  background: #f1f3f4c8;
  color: #5f6368;
  font-style: italic;
}

td.special {
  background: #f1f3f4c8;
  color: #202124;
  font-weight: bold;
  text-align: center;
}

/* ---------------- Responsive ---------------- */
@media (max-width: 768px) {
  #sidebar {
    width: 100%;
    height: auto;
    position: relative;
  }
  #main-content {
    margin-left: 0;
  }
}

/* Sidebar legend */
.legend-list {
  list-style: none;
  padding-left: 0;
  margin-top: 8px;
  font-size: 0.85rem;
  color: #dcdcdc;
}

.legend-list li {
  margin-bottom: 4px;
}

.legend-symbol {
  display: inline-block;
  min-width: 20px;
  font-weight: bold;
  color: #ffffff;
}

.legend-box {
  display: inline-block;
  width: 14px;
  height: 14px;
  border-radius: 3px;
  margin-right: 6px;
  vertical-align: middle;
}

.legend-box.pass {
  background-color: #155724; /* green */
}

.legend-box.fail {
  background-color: #721c24; /* red */
}

.section {
  margin: 0 auto 60px auto;
  max-width: 1200px;
}

.section h3 {
  font-weight: 600;
}

.table-responsive table {
  margin: 0 auto;
  border-collapse: collapse;
}

.table-responsive th {
  background-color: #f8f9fa;
  font-weight: bold;
  text-align: center;
}

.table-responsive td {
  text-align: center;
  vertical-align: middle;
}

@media print {
  #sidebar {
    display: none !important;
  }
  #main-content {
    margin: 0 !important;
    padding: 0 10px !important;
    width: 100% !important;
  }
  .section {
    page-break-after: always;
  }
  #stateChart {
    width: 100% !important;
    height: auto !important;
    aspect-ratio: 16/9;
    page-break-inside: avoid;
  }
}

/* ---------------- Export Button ---------------- */
#main-content .btn.btn-primary {
  background-color: transparent !important;
  color: #0a2239 !important; /* dark navy text */
  border: 1px solid #0a2239 !important;
  font-weight: 500;
  font-size: 0.85rem;
  padding: 6px 12px;
  transition: background-color 0.3s, color 0.3s;
}

#main-content .btn.btn-primary:hover {
  background-color: #e6eef5 !important; /* light grey-blue */
  color: #0a2239 !important; /* keep text navy */
}

#visualSummaryChart {
  margin-top: 30px;
}

/* Center plots and limit their max width */
.plot-container {
  max-width: 1300px;
  margin: 0 auto;
}

/* ---------------- State Summary Cards ---------------- */
#stateSummary {
  max-width: 100%;
  margin-top: 5px;
  border-top: 3px solid #dee2e6;
  padding-top: 20px;
}

#stateSummary .card {
  width: 100%;
  margin-bottom: 5px;
  border: 2px solid #0a2239 !important;
}

#stateSummary .card-header {
  background-color: #0a2239 !important;
  color: #ffffff !important;
  font-weight: bold;
  font-size: 1rem;
  text-align: center;
}

#stateSummary .list-group-item span:last-child {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

#stateSummary .badge {
  width: 100px;
  max-width: 160px;
  display: flex;
  justify-content: center;
  align-items: center;
  line-height: 1;
  font-weight: 600;
  padding: 6px 10px;
  text-align: center;
}

/* ---------------- Sidebar Toggle (Scorecard vs National) ---------------- */
#sidebarToggle {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
}

#sidebarToggle .btn {
  width: 100%;
  text-align: center;
  color: #ffffff;
  border: 1px solid #ffffff44;
  background-color: transparent;
  font-weight: 500;
  font-size: 0.9rem;
  padding: 8px 12px;
  border-radius: 4px;
  transition: background-color 0.3s, color 0.3s, box-shadow 0.2s;
}

#sidebarToggle .btn.active {
  background-color: #ffffff;
  color: #0a2239;
  font-weight: 600;
}

#sidebarToggle .btn:not(.active):hover {
  background-color: #173a5e;
  color: #ffffff;
  box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.2);
}

/* ---------------- State/Regional Toggle (Sidebar) ---------------- */
#sidebarStateRegionalToggle {
  display: flex;
  justify-content: center;
  width: 100%;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #ffffff44;
  margin-bottom: 15px;
}

#sidebarStateRegionalToggle .btn {
  flex: 1;
  border-radius: 0 !important;
  font-weight: 500;
  font-size: 0.9rem;
  padding: 8px 12px;
  text-align: center;
  color: #ffffff;
  background-color: transparent;
  border: none;
  transition: background-color 0.3s, color 0.3s, box-shadow 0.2s;
}

#sidebarStateRegionalToggle .btn.active {
  background-color: #ffffff;
  color: #0a2239;
  font-weight: 600;
}

#sidebarStateRegionalToggle .btn:not(.active):hover {
  background-color: #173a5e;
  color: #ffffff;
  box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.2);
}

/* ---------------- Plot Sections ---------------- */
.plot-section {
  margin: 50px auto 40px auto;
  max-width: 1100px;
  text-align: center;
}

.plot-section > h4 {
  font-size: 1.4rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 25px;
  padding-bottom: 8px;
  border-bottom: 2px solid #dee2e6;
  color: #0a2239;
}

.plot-container > h6 {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: #333;
}

.plot-container {
  margin-bottom: 45px;
  padding: 20px;
  border-radius: 8px;
  background-color: #ffffff;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.plot-container > div {
  width: 100% !important;
  height: 480px !important;
}
</style>
  </head>
  <body class="bg-light">
    <div id="sidebar" class="bg-dark text-white p-3">
      <h4 class="mb-3">U.S. Department of Labor</h4>

      <!-- Sidebar View Toggle -->
      <div class="mb-3 d-flex flex-column" id="sidebarToggle">
        <button
          type="button"
          class="btn btn-outline-primary active mb-2"
          data-view="national"
        >
          National Report
        </button>
        <button
          type="button"
          class="btn btn-outline-primary mb-2"
          data-view="regional"
        >
          Regional Report
        </button>
        <button type="button" class="btn btn-outline-primary" data-view="state">
          State Report
        </button>
      </div>

      <hr />

      <!-- Dataset -->
      <label for="datasetSelect" class="form-label">Dataset:</label>
      <select id="datasetSelect" class="form-select form-select-sm mb-2">
        <option value="July - June">July - June</option>
<option value="April - March">April - March</option>
      </select>

      <!-- State Selector -->
      <div id="stateSelectWrapper" style="display: none">
        <label for="stateSelect" class="form-label">State:</label>
        <select
          id="stateSelect"
          class="form-select form-select-sm mb-2"
        ></select>
      </div>

      <!-- Region Selector -->
      <div id="regionSelectWrapper" style="display: none">
        <label for="regionSelect" class="form-label">Region:</label>
        <select id='regionSelect' class='form-select form-select-sm'> <option value="Region 2 - Philadelphia">Region 2 - Philadelphia</option>
<option value="Region 3 - Atlanta">Region 3 - Atlanta</option> </select>
      </div>

      <div class="mt-3">
        Last updated:
        2025-09-15
      </div>

      <hr />
      <h6>Legend</h6>
      <ul class="legend-list">
        <li><span class="legend-symbol">&#9733;</span> Missing data</li>
        <li><span class="legend-symbol">&#8212;</span> Older data used</li>
        <li><span class="legend-box pass"></span> Meets / Pass (Green)</li>
        <li><span class="legend-box fail"></span> Fails Benchmark (Red)</li>
      </ul>
    </div>

    <div id="main-content" class="p-4">
      <!-- Header Row with Export Button -->
      <div class="d-flex justify-content-end mb-4">
        <button class="btn btn-sm btn-primary" onclick="window.print()">
          Export Report
        </button>
      </div>

      <!-- Performance Table Section -->
      <div
        class="section p-3 bg-white shadow-sm rounded"
        id="performanceSection"
      >
        <div class="position-relative mb-3 text-center">
          <h3 class="mb-2">Performance Metrics</h3>
        </div>

        <p class="text-muted text-center">
          This section shows the performance of states and regions relative to
          <b>National Average (NAVG)</b> and
          <b>Acceptable Levels of Performance (ALP)</b>. The Score Cards provide
          on-going information on states' performance and are intended to
          complement oversight activities.
        </p>
        <div id="scorecard-table" class="table-responsive"></div>

        <div id="stateSummary" class="mt-4"></div>
      </div>

      <!-- Visual Plots Section -->
      <div
        class="section p-3 bg-white shadow-sm rounded"
        id="plotsSection"
        style="display: none"
      >
        <div id="plotsContainer" class="mt-3"></div>
      </div>
    </div>

    <script>
var DATASETS = {'July - June':{ regions:{'Region 2 - Philadelphia':['DC','DE','MD','PA','VA','WV'], 'Region 3 - Atlanta':['AL','FL','GA','KY','MS','NC','SC','TN']}, metrics:[{ section:'Benefits Measures', label:'First Payment Promptness (%)', values:{DC:64.175,DE:51.533,MD:66.125,PA:74.2538,VA:82.625,WV:84.7583,AL:53.553,FL:45.967,GA:75.167,KY:60.108,MS:83.667,NC:72.525,SC:91.383,TN:89.642,NATIONAL:71.1} },
{ section:'Program Integrity Measures', label:'Overpayment Detection (%)', values:{DC:46.01,DE:60.87,MD:187.87,PA:38.88,VA:283.3,WV:38.88,AL:160.5,FL:63.187,GA:107.545,KY:555.861,MS:229.102,NC:134.995,SC:76.747,TN:88.225,NATIONAL:148} },
{ section:'Program Integrity Measures', label:'Improper Payments Measure (%)', values:{DC:13.235,DE:26.177,MD:7.136,PA:10.033,VA:18.563,WV:7.868,AL:7.643,FL:23.207,GA:7.94,KY:35.344,MS:8.192,NC:22.162,SC:7.292,TN:26.523,NATIONAL:15.8} },
{ section:'Program Integrity Measures', label:'UI Overpayment Recovery Measure (%)', values:{DC:40.72,DE:88.49,MD:12.62,PA:31.96,VA:-139.7,WV:80.96,AL:47.8,FL:20.43,GA:28.26,KY:45.17,MS:193.71,NC:94.16,SC:203.07,TN:67.32,NATIONAL:58.2} }] },
'April - March':{ regions:{'Region 2 - Philadelphia':['DC','DE','MD','PA','VA','WV'], 'Region 3 - Atlanta':['AL','FL','GA','KY','MS','NC','SC','TN']}, metrics:[{ section:'Benefits Measures', label:'First Payment Promptness (%)', values:{DC:60.842,DE:52.108,MD:63.725,PA:70.85,VA:82.058,WV:85.05,AL:43.67,FL:52.95,GA:74.517,KY:56.25,MS:82.792,NC:73.625,SC:91.883,TN:86.183,NATIONAL:69.8} },
{ section:'Program Integrity Measures', label:'Overpayment Detection (%)', values:{DC:41.707,DE:48.835,MD:226.099,PA:34.472,VA:207.375,WV:39.801,AL:125.962,FL:69.984,GA:78.419,KY:551.426,MS:239.5,NC:144.257,SC:67.715,TN:48,NATIONAL:137.4} },
{ section:'Program Integrity Measures', label:'Improper Payments Measure (%)', values:{DC:14.039,DE:34.477,MD:6.785,PA:10.607,VA:18.05,WV:9.817,AL:7.202,FL:28.379,GA:6.752,KY:35.172,MS:8.685,NC:20.578,SC:7.91,TN:22.255,NATIONAL:16.5} },
{ section:'Program Integrity Measures', label:'UI Overpayment Recovery Measure (%)', values:{DC:67.44,DE:83.51,MD:13.8,PA:41.9,VA:-390.14,WV:71.29,AL:41.68,FL:12.89,GA:28.19,KY:-32.06,MS:179.08,NC:104.55,SC:194.33,TN:77.78,NATIONAL:35.3} }] }};
</script>

    <script>
// ---------------- Classification ----------------
function getClassForValue(label, val) {
  if (val === undefined || val === null) return "";

  if (!isNaN(parseFloat(val))) {
    let num = parseFloat(val);
    if (label.includes("First Payment Promptness"))
      return num >= 87 ? "pass" : "fail";
    if (label.includes("Overpayment Detection"))
      return num >= 50 ? "pass" : "fail";
    if (label.includes("Improper Payments Measure"))
      return num < 10 ? "pass" : "fail";
    if (label.includes("UI Overpayment Recovery Measure"))
      return num >= 68 ? "pass" : "fail";
    if (num >= 85) return "pass";
    if (num >= 75) return "warning";
    return "fail";
  }

  val = String(val).toUpperCase();
  if (val === "F") return "fail";
  if (val === "P") return "pass";
  if (val === "N/A") return "na";
  if (val === "*") return "special";
  return "";
}

function getDisplayValue(val) {
  if (val === undefined || val === null) return "";
  if (!isNaN(parseFloat(val))) return val;
  val = String(val).toUpperCase();
  if (val === "F") return " F";
  if (val === "P") return " P";
  if (val === "N/A") return "Ã¢â‚¬â€";
  if (val === "*") return "Ã¢Ëœâ€¦";
  return val;
}

// ---------------- Benchmarks ----------------
function getBenchmark(label) {
  if (label.includes("First Payment Promptness")) return 87;
  if (label.includes("Overpayment Detection")) return 50;
  if (label.includes("Improper Payments Measure")) return 10;
  if (label.includes("UI Overpayment Recovery Measure")) return 68;
  return 85;
}

function getBenchmarkDisplay(label) {
  if (label.includes("First Payment Promptness")) return "&ge; 87";
  if (label.includes("Overpayment Detection")) return "&ge; 50";
  if (label.includes("Improper Payments Measure")) return "&le; 10";
  if (label.includes("UI Overpayment Recovery Measure")) return "&ge; 68";
  return "&ge; 85";
}

// ---------------- Regional Table ----------------
function renderTable(datasetName, region) {
  let dataset = DATASETS[datasetName];
  let states = dataset.regions[region];
  let html = "<table class='table table-bordered table-sm'>";
  html +=
    "<thead><tr><th>Metric</th>" +
    states.map((s) => `<th>${s}</th>`).join("") +
    "</tr></thead><tbody>";

  let currentSection = "";
  for (let metric of dataset.metrics) {
    if (metric.section !== currentSection) {
      html += `<tr class='section-header'><td colspan='${states.length + 1}'>${
        metric.section
      }</td></tr>`;
      currentSection = metric.section;
    }
    html += `<tr><td>${metric.label}</td>`;
    for (let st of states) {
      let val = metric.values[st];
      let cls = getClassForValue(metric.label, val);
      let disp = getDisplayValue(val);
      html += `<td class='${cls}'>${disp ?? ""}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody></table>";

  document.getElementById("scorecard-table").innerHTML = html;
  document.getElementById("stateSummary").innerHTML = "";

  // render regional plots
  renderRegionalPlots(datasetName, region);
}

// ---------------- National ----------------
function renderNational(datasetName) {
  let dataset = DATASETS[datasetName];
  let html =
    "<table class='table table-bordered table-sm'><thead><tr><th>Metric</th><th>National Avg</th></tr></thead><tbody>";

  let currentSection = "";
  for (let metric of dataset.metrics) {
    if (metric.section !== currentSection) {
      html += `<tr class='section-header'><td colspan='2'>${metric.section}</td></tr>`;
      currentSection = metric.section;
    }
    let val = metric.values["NATIONAL"];
    html += `<tr><td>${metric.label}</td><td>${val}</td></tr>`;
  }
  html += "</tbody></table>";

  document.getElementById("scorecard-table").innerHTML = html;
  document.getElementById("stateSummary").innerHTML = "";
  document.getElementById("plotsSection").style.display = "none";
}

// ---------------- State Comparison ----------------
function renderStateComparison(datasetName, state) {
  let dataset = DATASETS[datasetName];
  let html =
    "<table class='table table-bordered table-sm'><thead><tr><th>Metric</th><th>ALP</th><th>" +
    state +
    "</th><th>National Average</th></tr></thead><tbody>";

  let worseThanNatl = [];
  let failedBenchmarks = [];
  let currentSection = "";

  for (let metric of dataset.metrics) {
    if (metric.section !== currentSection) {
      html += `<tr class='section-header'><td colspan='4'>${metric.section}</td></tr>`;
      currentSection = metric.section;
    }

    let sValRaw = metric.values[state];
    let nValRaw = metric.values["NATIONAL"];
    let sVal = parseFloat(sValRaw);
    let nVal = parseFloat(nValRaw);

    let benchmarkDisp = getBenchmarkDisplay(metric.label);

    let sDisp = getDisplayValue(sValRaw);
    let nDisp = getDisplayValue(nValRaw);
    let sCls = getClassForValue(metric.label, sValRaw);

    html += `<tr><td>${metric.label}</td><td>${benchmarkDisp}</td><td class='${sCls}'>${sDisp}</td><td>${nDisp}</td></tr>`;

    if (!isNaN(sVal) && !isNaN(nVal) && sVal < nVal)
      worseThanNatl.push({
        label: metric.label,
        diff: (nVal - sVal).toFixed(1),
      });

    let meets = false;
    if (!isNaN(sVal)) {
      if (metric.label.includes("First Payment Promptness")) meets = sVal >= 87;
      else if (metric.label.includes("Overpayment Detection"))
        meets = sVal >= 50;
      else if (metric.label.includes("Improper Payments Measure"))
        meets = sVal < 10;
      else if (metric.label.includes("UI Overpayment Recovery Measure"))
        meets = sVal >= 68;
      else meets = sVal >= 85;
    }
    if (!meets && !isNaN(sVal)) {
      let bench = getBenchmark(metric.label);
      let diff = Math.abs(sVal - bench).toFixed(1);
      failedBenchmarks.push({ label: metric.label, diff: diff });
    }
  }
  html += "</tbody></table>";
  document.getElementById("scorecard-table").innerHTML = html;

  // Summary
  let summaryEl = document.getElementById("stateSummary");
  summaryEl.style.display = "block";

  let summaryHTML = "";

  summaryHTML += `<p class="text-muted text-center mt-4 mb-3">
    This section provides a breakdown analysis of the underperforming
    metrics and recommended actions to resolve unmet ALPs. The
    underperforming metrics provide a percentage difference of metrics
    compared to the NAVG and ALP, while the recommended actions provide
    dynamic statements to assist in meeting ALP standards.
  </p>`;

  summaryHTML += `<div class="card mb-3">
    <div class="card-header">Underperforming Metrics</div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm mb-0">
        <thead>
          <tr>
            <th>Metric</th>
            <th>${state}</th>
            <th>ALP</th>
            <th>National Average</th>
          </tr>
        </thead>
        <tbody>`;

  if (worseThanNatl.length > 0 || failedBenchmarks.length > 0) {
    let combined = {};

    worseThanNatl.forEach((m) => {
      if (!combined[m.label]) {
        let rawVal = dataset.metrics.find((x) => x.label === m.label).values[
          state
        ];
        combined[m.label] = {
          stateVal: rawVal,
          alp: "&#8212;",
          navg: "&#8212;",
        };
      }
      combined[m.label].navg = `${m.diff}`;
    });

    failedBenchmarks.forEach((m) => {
      if (!combined[m.label]) {
        let rawVal = dataset.metrics.find((x) => x.label === m.label).values[
          state
        ];
        combined[m.label] = {
          stateVal: rawVal,
          alp: "&#8212;",
          navg: "&#8212;",
        };
      }
      combined[m.label].alp = `${m.diff}`;
    });

    for (let metric in combined) {
      let rawVal = combined[metric].stateVal;
      let sDisp = getDisplayValue(rawVal);
      let sCls = getClassForValue(metric, rawVal);

      summaryHTML += `
        <tr>
          <td>${metric}</td>
          <td class='${sCls}'>${sDisp}</td>
          <td>${combined[metric].alp}</td>
          <td>${combined[metric].navg}</td>
        </tr>`;
    }
  } else {
    summaryHTML += `
      <tr>
        <td colspan="4" class="text-success text-center">
          <strong>All metrics meet/exceed benchmarks and national averages.</strong>
        </td>
      </tr>`;
  }

  summaryHTML += `</tbody></table></div></div>`;

  // ---------------- Recommendations card ----------------
  summaryHTML += `<div class="card mb-3">
    <div class="card-header">Recommended Actions for ALP</div>
    <ul class="list-group list-group-flush">`;

  if (failedBenchmarks.length > 0) {
    failedBenchmarks.forEach((m) => {
      if (m.label.includes("First Payment Promptness")) {
        summaryHTML += `<li class="list-group-item"><strong>${m.label}:</strong> Enhance claims processing efficiency through staff training and workflow automation.</li>`;
      } else if (m.label.includes("Overpayment Detection")) {
        summaryHTML += `<li class="list-group-item"><strong>${m.label}:</strong> Strengthen fraud detection protocols and increase data cross-matching to identify overpayments earlier.</li>`;
      } else if (m.label.includes("Improper Payments Measure")) {
        summaryHTML += `<li class="list-group-item"><strong>${m.label}:</strong> Implement stricter eligibility verification processes and provide clearer claimant guidance.</li>`;
      } else if (m.label.includes("UI Overpayment Recovery Measure")) {
        summaryHTML += `<li class="list-group-item"><strong>${m.label}:</strong> Improve recovery strategies through enhanced claimant outreach, repayment plans, and data-driven collection efforts.</li>`;
      } else {
        summaryHTML += `<li class="list-group-item"><strong>${m.label}:</strong> Develop targeted action plans to address gaps and align results with benchmark standards.</li>`;
      }
    });
  } else {
    summaryHTML += `<li class="list-group-item text-success"><strong>All benchmarks met Ã¢â‚¬â€ maintain current practices.</strong></li>`;
  }

  summaryHTML += `</ul></div>`;

  summaryEl.innerHTML = summaryHTML;

  // ---------------- Plots ----------------
  document.getElementById("plotsSection").style.display = "block";
  let grouped = {};
  for (let m of dataset.metrics) {
    if (!grouped[m.section]) grouped[m.section] = [];
    grouped[m.section].push(m);
  }
  let plotsContainer = document.getElementById("plotsContainer");
  plotsContainer.innerHTML = "";

  Object.keys(grouped).forEach((section) => {
    let secDiv = document.createElement("div");
    secDiv.className = "plot-section";
    secDiv.innerHTML = `<h4 class="text-center mb-4">${section}</h4>`;
    plotsContainer.appendChild(secDiv);

    let div = document.createElement("div");
    div.className = "plot-container";
    div.innerHTML = `
    <div id="plot-${section.replace(/\s+/g, "-")}" 
         style="width:100%;height:480px;"></div>`;
    secDiv.appendChild(div);

    renderCategoryPlot(section, grouped[section], state);
  });
}

// ---------------- Render Category Plot (State) ----------------
function renderCategoryPlot(section, metrics, state) {
  let labels = [];
  let stateVals = [];
  let natlVals = [];
  let benchmarks = [];

  for (let metric of metrics) {
    let sVal = parseFloat(metric.values[state]);
    let nVal = parseFloat(metric.values["NATIONAL"]);
    let benchmark = getBenchmark(metric.label);

    if (!isNaN(sVal) && !isNaN(nVal)) {
      labels.push(metric.label);
      stateVals.push(sVal);
      natlVals.push(nVal);
      benchmarks.push(benchmark);
    }
  }

  const colors = ["#5070dd", "#b6d634", "#505372"];

  let chartDom = document.getElementById(
    `plot-${section.replace(/\s+/g, "-")}`
  );
  echarts.dispose(chartDom);
  let chart = echarts.init(chartDom);

  let barWidth = Math.max(60, 70 / metrics.length);
  let barCategoryGap = metrics.length > 6 ? "5%" : "30%";

  let option = {
    color: colors,
    tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
    legend: { data: ["National Avg", state, "Benchmark"], top: 0 },
    grid: { left: "3%", right: "4%", bottom: 50, top: 60, containLabel: true },
    xAxis: [
      { type: "category", data: labels, axisLabel: { show: false } },
      {
        type: "category",
        data: labels,
        position: "top",
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: {
          show: true,
          fontWeight: "bold",
          color: "#333",
          margin: 10,
          interval: 0,
          formatter: function (value) {
            return value.replace(/(.{20})/g, "$1\n");
          },
        },
      },
    ],
    yAxis: { type: "value", name: "Value" },
    series: [
      {
        name: "National Avg",
        type: "bar",
        data: natlVals,
        barWidth: barWidth,
        barCategoryGap: barCategoryGap,
        itemStyle: { color: colors[0] },
      },
      {
        name: state,
        type: "bar",
        data: stateVals,
        barWidth: barWidth,
        barCategoryGap: barCategoryGap,
        itemStyle: { color: colors[1] },
      },
      {
        name: "Benchmark",
        type: "line",
        data: benchmarks,
        symbol: "circle",
        symbolSize: 8,
        lineStyle: { color: colors[2], width: 3, type: "dashed" },
        itemStyle: { color: colors[2] },
      },
    ],
  };

  chart.setOption(option);

  const animDuration = option.animationDuration || 1000;
  setTimeout(() => {
    chart.resize();
  }, animDuration + 200);
}

// ---------------- Regional Plots ----------------
function renderRegionalPlots(datasetName, region) {
  let dataset = DATASETS[datasetName];
  let states = dataset.regions[region];

  let grouped = {};
  for (let m of dataset.metrics) {
    if (!grouped[m.section]) grouped[m.section] = [];
    grouped[m.section].push(m);
  }

  let plotsContainer = document.getElementById("plotsContainer");
  plotsContainer.innerHTML = "";

  Object.keys(grouped).forEach((section) => {
    let secDiv = document.createElement("div");
    secDiv.className = "plot-section";
    secDiv.innerHTML = `<h4 class="text-center mb-4">${section}</h4>`;
    plotsContainer.appendChild(secDiv);

    grouped[section].forEach((metric) => {
      let div = document.createElement("div");
      div.className = "plot-container";
      div.style.marginBottom = "40px";
      div.innerHTML = `<h6 class="text-center mb-2">${metric.label}</h6>
        <div id="regional-plot-${metric.label.replace(/\s+/g, "-")}" 
             style="width:100%;height:500px;"></div>`;
      secDiv.appendChild(div);

      setTimeout(() => renderRegionalMetricPlot(metric, states), 50);
    });
  });

  document.getElementById("plotsSection").style.display = "block";
}

function renderRegionalMetricPlot(metric, states) {
  let stateVals = states.map((st) => {
    let v = parseFloat(metric.values[st]);
    return isNaN(v) ? null : v;
  });

  let benchmark = getBenchmark(metric.label);
  let natl = parseFloat(metric.values["NATIONAL"]);

  let chartDom = document.getElementById(
    `regional-plot-${metric.label.replace(/\s+/g, "-")}`
  );
  echarts.dispose(chartDom);
  let chart = echarts.init(chartDom);

  let colors = [
    "#1f77b4",
    "#ff7f0e",
    "#2ca02c",
    "#d62728",
    "#9467bd",
    "#8c564b",
    "#e377c2",
    "#7f7f7f",
    "#bcbd22",
    "#17becf",
  ];

  let barWidth = Math.max(60, 80 / states.length);
  let barCategoryGap = states.length > 6 ? "10%" : "30%";

  let option = {
    tooltip: { trigger: "axis" },
    legend: { top: 0, data: ["States", "Benchmark", "National Avg"] },
    grid: { left: "3%", right: "4%", bottom: 50, top: 60, containLabel: true },
    xAxis: { type: "category", data: states },
    yAxis: { type: "value", name: "Value" },
    series: [
      {
        name: "States",
        type: "bar",
        data: stateVals,
        barWidth: barWidth,
        barCategoryGap: barCategoryGap,
        itemStyle: {
          color: (params) => colors[params.dataIndex % colors.length],
        },
      },
      {
        name: "Benchmark",
        type: "line",
        data: stateVals.map(() => benchmark),
        lineStyle: { color: "#d62728", type: "dotted", width: 3 },
        symbol: "circle",
        symbolSize: 6,
        itemStyle: { color: "#d62728" },
        markLine: {
          silent: true,
          symbol: "none",
          label: {
            show: true,
            position: "end",
            formatter: benchmark.toFixed(1),
            color: "#d62728",
            fontWeight: "bold",
          },
          lineStyle: { type: "dotted", color: "#d62728", width: 3 },
          data: [{ yAxis: benchmark }],
        },
      },
      {
        name: "National Avg",
        type: "line",
        data: stateVals.map(() => natl),
        lineStyle: { color: "#1f77b4", type: "dotted", width: 3 },
        symbol: "circle",
        symbolSize: 6,
        itemStyle: { color: "#1f77b4" },
        markLine: {
          silent: true,
          symbol: "none",
          label: {
            show: true,
            position: "end",
            formatter: natl.toFixed(1),
            color: "#1f77b4",
            fontWeight: "bold",
          },
          lineStyle: { type: "dotted", color: "#1f77b4", width: 3 },
          data: [{ yAxis: natl }],
        },
      },
    ],
    animationDuration: 1000,
  };

  chart.setOption(option);

  setTimeout(() => {
    chart.resize();
  }, 1200);
}

// ---------------- Populate States ----------------
function populateStates(datasetName) {
  let regions = DATASETS[datasetName].regions;
  let states = Object.values(regions).flat();
  states.sort((a, b) => a.localeCompare(b));
  let stateSelect = document.getElementById("stateSelect");
  stateSelect.innerHTML = states
    .map((s) => `<option value="${s}">${s}</option>`)
    .join("");
}

// ---------------- State ----------------
let currentDataset = Object.keys(DATASETS)[0];

// ---------------- Dataset Select ----------------
document
  .getElementById("datasetSelect")
  .addEventListener("change", function () {
    currentDataset = this.value;

    let activeView = document.querySelector("#sidebarToggle .btn.active");

    if (activeView.dataset.view === "state") {
      document.getElementById("stateSelectWrapper").style.display = "block";
      document.getElementById("regionSelectWrapper").style.display = "none";
      populateStates(currentDataset);
      renderStateComparison(
        currentDataset,
        document.getElementById("stateSelect").value
      );
    } else if (activeView.dataset.view === "regional") {
      document.getElementById("stateSelectWrapper").style.display = "none";
      document.getElementById("regionSelectWrapper").style.display = "block";
      let firstRegion = Object.keys(DATASETS[currentDataset].regions)[0];
      renderTable(currentDataset, firstRegion);
    } else {
      document.getElementById("stateSelectWrapper").style.display = "none";
      document.getElementById("regionSelectWrapper").style.display = "none";
      renderNational(currentDataset);
    }
  });

// ---------------- Region Select ----------------
document.getElementById("regionSelect").addEventListener("change", function () {
  renderTable(currentDataset, this.value);
});

// ---------------- State Select ----------------
document.getElementById("stateSelect").addEventListener("change", function () {
  renderStateComparison(currentDataset, this.value);
});

// ---------------- Sidebar Toggle (National / Regional / State) ----------------
document.querySelectorAll("#sidebarToggle .btn").forEach((btn) => {
  btn.addEventListener("click", function () {
    document
      .querySelectorAll("#sidebarToggle .btn")
      .forEach((el) => el.classList.remove("active"));
    this.classList.add("active");

    let mode = this.getAttribute("data-view");

    if (mode === "national") {
      document.getElementById("stateSelectWrapper").style.display = "none";
      document.getElementById("regionSelectWrapper").style.display = "none";
      renderNational(currentDataset);
    } else if (mode === "regional") {
      document.getElementById("stateSelectWrapper").style.display = "none";
      document.getElementById("regionSelectWrapper").style.display = "block";
      let firstRegion = Object.keys(DATASETS[currentDataset].regions)[0];
      renderTable(currentDataset, firstRegion);
      document.getElementById("stateSummary").innerHTML = "";
    } else if (mode === "state") {
      document.getElementById("stateSelectWrapper").style.display = "block";
      document.getElementById("regionSelectWrapper").style.display = "none";
      populateStates(currentDataset);
      renderStateComparison(
        currentDataset,
        document.getElementById("stateSelect").value
      );
    }
  });
});

// ---------------- Initial Render ----------------
renderNational(currentDataset);
document.getElementById("regionSelectWrapper").style.display = "none";
document.getElementById("stateSelectWrapper").style.display = "none";
</script>

    <script>
      // Default: National Report
      let currentDataset = Object.keys(DATASETS)[0];
      renderNational(currentDataset);
      document.getElementById("regionSelectWrapper").style.display = "none";
      document.getElementById("stateSelectWrapper").style.display = "none";

      // Sidebar toggle buttons
      document.querySelectorAll("#sidebarToggle .btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          document
            .querySelectorAll("#sidebarToggle .btn")
            .forEach((el) => el.classList.remove("active"));
          this.classList.add("active");

          let mode = this.getAttribute("data-view");

          if (mode === "national") {
            renderNational(currentDataset);
            document.getElementById("regionSelectWrapper").style.display =
              "none";
            document.getElementById("stateSelectWrapper").style.display =
              "none";
          } else if (mode === "regional") {
            let firstRegion = Object.keys(DATASETS[currentDataset].regions)[0];
            renderTable(currentDataset, firstRegion);
            document.getElementById("regionSelectWrapper").style.display =
              "block";
            document.getElementById("stateSelectWrapper").style.display =
              "none";
          } else if (mode === "state") {
            populateStates(currentDataset);
            renderStateComparison(
              currentDataset,
              document.getElementById("stateSelect").value
            );
            document.getElementById("stateSelectWrapper").style.display =
              "block";
            document.getElementById("regionSelectWrapper").style.display =
              "none";
          }
        });
      });
    </script>
  </body>
</html>
